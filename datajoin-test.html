<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Join local JSON data with vector tile geometries</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.48.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.48.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>


<div id='map'>
</div>
<script>


/**
 * ZCTA wise metric details
 * @type {Object}
 */
var zcta_metrics = {};

/**
 * ZCTA to GEO ID Mapping
 * @type {Object}
 */
var zcta_geoid = {};

/**
 * COUNTY to GEO ID Mapping
 * @type {Object}
 */
var county_geoid = {};

var oProfiles = {};



mapboxgl.accessToken = 'pk.eyJ1IjoiaWFzaGlzaHNpbmdoIiwiYSI6ImNqbHQ2d2JpcTA1cnEzcG9idGl2aTN5MTMifQ.yGUYoyQ4IyAfzl3E2D0ecA';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v9',
    center: [-99.9, 41.5],
    zoom: 1
});

// Join local JSON data with vector tile geometry
// USA unemployment rate in 2009
// Source https://data.bls.gov/timeseries/LNS14000000
var maxValue = 13;
var data = [
    {"STATE_ID": "01", "unemployment": 13.17},
    {"STATE_ID": "02", "unemployment": 9.5},
    {"STATE_ID": "04", "unemployment": 12.15},
    {"STATE_ID": "05", "unemployment": 8.99},
    {"STATE_ID": "06", "unemployment": 11.83},
    {"STATE_ID": "08", "unemployment": 7.52},
    {"STATE_ID": "09", "unemployment": 6.44},
    {"STATE_ID": "10", "unemployment": 5.17},
    {"STATE_ID": "12", "unemployment": 9.67},
    {"STATE_ID": "13", "unemployment": 10.64},
    {"STATE_ID": "15", "unemployment": 12.38},
    {"STATE_ID": "16", "unemployment": 10.13},
    {"STATE_ID": "17", "unemployment": 9.58},
    {"STATE_ID": "18", "unemployment": 10.63},
    {"STATE_ID": "19", "unemployment": 8.09},
    {"STATE_ID": "20", "unemployment": 5.93},
    {"STATE_ID": "21", "unemployment": 9.86},
    {"STATE_ID": "22", "unemployment": 9.81},
    {"STATE_ID": "23", "unemployment": 7.82},
    {"STATE_ID": "24", "unemployment": 8.35},
    {"STATE_ID": "25", "unemployment": 9.1},
    {"STATE_ID": "26", "unemployment": 10.69},
    {"STATE_ID": "27", "unemployment": 11.53},
    {"STATE_ID": "28", "unemployment": 9.29},
    {"STATE_ID": "29", "unemployment": 9.94},
    {"STATE_ID": "30", "unemployment": 9.29},
    {"STATE_ID": "31", "unemployment": 5.45},
    {"STATE_ID": "32", "unemployment": 4.21},
    {"STATE_ID": "33", "unemployment": 4.27},
    {"STATE_ID": "34", "unemployment": 4.09},
    {"STATE_ID": "35", "unemployment": 7.83},
    {"STATE_ID": "36", "unemployment": 8.01},
    {"STATE_ID": "37", "unemployment": 9.34},
    {"STATE_ID": "38", "unemployment": 11.23},
    {"STATE_ID": "39", "unemployment": 7.08},
    {"STATE_ID": "40", "unemployment": 11.22},
    {"STATE_ID": "41", "unemployment": 6.2},
    {"STATE_ID": "42", "unemployment": 9.11},
    {"STATE_ID": "44", "unemployment": 10.42},
    {"STATE_ID": "45", "unemployment": 8.89},
    {"STATE_ID": "46", "unemployment": 11.03},
    {"STATE_ID": "47", "unemployment": 7.35},
    {"STATE_ID": "48", "unemployment": 8.92},
    {"STATE_ID": "49", "unemployment": 7.65},
    {"STATE_ID": "50", "unemployment": 8.01},
    {"STATE_ID": "51", "unemployment": 7.62},
    {"STATE_ID": "53", "unemployment": 7.77},
    {"STATE_ID": "54", "unemployment": 8.49},
    {"STATE_ID": "55", "unemployment": 9.42},
    {"STATE_ID": "56", "unemployment": 7.59}
];

map.on('load', function() {

    // Add source for state polygons hosted on Mapbox, based on US Census Data:
    // https://www.census.gov/geo/maps-data/data/cbf/cbf_state.html
    map.addSource("counties", {
        type: "vector",
        //url: "mapbox://mapbox.us_census_states_2015"
        //counties
        url: 'mapbox://iashishsingh.26qg4tx9'
    });

    // Load custom data
    loadData(function(countiesGeoJson){

        map.addSource("counties-localdata", {
            "type": "geojson",
            "data": countiesGeoJson
        });
        
        // Add layer from the vector tile source with data-driven style
        map.addLayer({
            "id": "counties-join",
            "type": "fill",
            //"source": "counties",
            "source": "counties-localdata",
            //"source-layer": "states",
            //"source-layer": "us-census-vis",
            //"source-layer": "gz_2010_us_20m-aqxozo",
            
            //"source-layer": "gz_2010_us_050_00_20m-a22ia7",

            "paint": {
                //"fill-color": aExpression
                'fill-color': [
                    'interpolate',
                    ['linear'],
                    ['get', 'unemp_rate'],
                    0, '#F2F12D',
                    2, '#EED322',
                    5, '#E6B71E',
                    6, '#DA9C20',
                    8, '#CA8323',
                    15, '#B86B25'
                ],
                'fill-opacity': 0.75
            }
        }, 'waterway-label');
        
    });
});


function loadData(callback) {

    // Load unemployment dataset
    //
    d3.csv('data/viz/Unemployment-Unsorted.csv', function(d){

        // sanitize percentage value
        // make them numeric
        // 

        d.unemp_rate = parseInt(d.unemp_rate) || 0;
        d.sample_count = parseInt(d.sample_count) || 0;

        // Store in zcta_metrics
        // 
        zcta_metrics[d.zcta] = d;

        return d;

    }).then(function(aUnemployment){

        console.log("unemployment dataset", zcta_metrics['01001']);

        delete aUnemployment.columns;

    });

    // Load Population Density dataset
    // 
    d3.csv("data/viz/Zipcode-ZCTA-Population-Density-And-Area-Unsorted.csv", function(d){

        //zcta,2010_population,land_sq_mi,density_sq_mile
        //

        d.density_sq_mile = parseFloat(d.density_sq_mile) || 0;

        // Update in zcta_metrics
        // 
        if (zcta_metrics[d.zcta]) {
            zcta_metrics[d.zcta].density_sq_mile = d.density_sq_mile;
        }

        return d;

    }).then(function(aPopulationDensity){
        
        console.log("Population Density dataset", zcta_metrics['01001']);

    });

        // Load ZCTA to COUNTY, GEOID Mapping
    // 
    d3.csv("data/CSV/zcta_county_rel_10.csv", function(d){

        zcta_geoid[d.ZCTA5] = d.GEOID;

        //zcta_geoid[d.ZCTA5] = d.GEOID;
        //
        // Multiple ZCTA may point to same GEOID;
        // 
        // TODO - Metrics for a GEOID should be formed by averaging the
        // data of all the ZCTAs it represents.

    }).then(function(){

        // Load Counties GeoJSON
        // 
        d3.json("data/GeoJSON/counties/gz_2010_us_050_00_20m.json").then(function(geojson){

            // Loop through features
            // 
            var sKeyGeoId,
            oMissing = {},
            oFeaturesZCTA = {},
            oMissingFeaturesZCTA = {};

            geojson.features.forEach(function(f){

                // add metrics to feature properties
                // to enable data visulaization via MapBox GL JS
                // 
                sKeyGeoId = f.properties.STATE + f.properties.COUNTY;
                
                oFeaturesZCTA[sKeyGeoId] = true;

                if (zcta_metrics[sKeyGeoId]) {

                    f.properties = Object.assign(f.properties, zcta_metrics[sKeyGeoId]);

                }else{
                    //console.log('not found', sKeyGeoId, f.properties.NAME);
                    oMissing[f.properties.STATE] = oMissing[f.properties.STATE] || {};
                    oMissing[f.properties.STATE][f.properties.COUNTY] = oMissing[f.properties.STATE][f.properties.COUNTY] || 0;
                    ++oMissing[f.properties.STATE][f.properties.COUNTY];
                }

                // check for features which are missing in our geojson data
                // We have profiles for these zips
            });

            callback(geojson);

            console.log('#Missing Counties', oMissing);

            //console.log("geojson dataset", geojson);
            //

            // Load Profiles
            // 
            d3.csv("data/viz/0-Raw-Data-Sample-ORIGINAL.csv", function(d){
                
                // Not the Camel-Case in Zip
                // 
                var zcta = d.Zip.length == 4 ? ('0'+d.Zip) : d.Zip;

                oProfiles[zcta] = oProfiles[zcta] || {
                    count: 0,
                    profiles: []
                };

                ++oProfiles[zcta].count;
                oProfiles[zcta].profiles.push(d);

                if (!oFeaturesZCTA[zcta]) {
                    oMissingFeaturesZCTA[zcta] = oMissingFeaturesZCTA[zcta] || 0;
                    ++oMissingFeaturesZCTA[zcta];
                }

            }).then(function(aProfiles){

                console.log('missing profiles for features', aProfiles, Object.keys(oMissingFeaturesZCTA).length, oProfiles);

            });

        });

    });
    


}


</script>

</body>
</html>